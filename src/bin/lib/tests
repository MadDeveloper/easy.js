#!/usr/bin/env node
import fs           from 'fs'
import walk         from 'walk'
import Mocha        from 'mocha'
import path         from 'path'
import readlineSync from 'readline-sync'
import _            from 'lodash'
import minimist     from 'minimist'
import config       from './../../config/config'
import App          from './../../bootstrap.js'

let argv    = minimist( process.argv.slice( 2 ) )
let cliMode = true

const app                   = new App( config, cliMode )
const kernel                = app.kernel
const bundleManager         = app.bundleManager
const container             = bundleManager.container
const message               = container.getComponent( 'Message' )

/*
 * Instantiate a Mocha instance
 */
const mocha = new Mocha()

const libsTestsDirectory = kernel.path.lib + '/tests'

/*
 * Expose container into global scope for unit tests classes, because file are called by mocha and not ourselves
 */
global.container = container

/*
 * Add each .js file to the mocha instance
 */
const specFiles = fs.readdirSync( libsTestsDirectory )

if ( specFiles && specFiles.length > 0 ) {
    specFiles.forEach( specFile => {
        mocha.addFile(
            path.join( libsTestsDirectory, specFile )
        )
    })
}
/*
 * Run the tests
 */
mocha.run( failures => {
    if ( failures ) {
        message.warn( failures  + ' failures occurs during tests.' )
    }
    process.exit()
})
