#!/usr/bin/env node
var fs              = require( 'fs' );
var walk            = require( 'walk' );
var path            = require( 'path' );
var readlineSync    = require( 'readline-sync' );
var _               = require( 'lodash' );
var argv            = require( 'minimist' )( process.argv.slice( 2 ) );

var cliMode         = true;
var config          = require( __dirname + '/../../build/config/config' );
var app             = require( __dirname + '/../../build/bootstrap.js' )( config, cliMode );
var Message         = app.kernel.load( 'Message' )();
var schemaBuilder   = app.bundleManager.container.getService( 'database/schema' );
var stringTransform = app.bundleManager.container.getService( 'string/transform' );

/*
 * Apply Polyfills
 */
require( global.app.root + '/vendor/easy/core/polyfills' );

var nameBundleFromArgv = argv._[ 0 ] || argv.name || argv.n || "";

if ( nameBundleFromArgv.length > 0 ) {

    var nameBundle          = nameBundleFromArgv.toLowerCase().trim(),
        bundlesPath         = global.app.root + "/src/bundles";
    var nameBundleLowerCase = nameBundle.decapitalizeFirstLetter(),
        skeletonBundlePath  = bundlesPath + "/skeleton",
        bundleCreatingPath  = bundlesPath + "/" + nameBundle;

    var positiveAnswers = [ 'y', 'ye', 'yes' ];
    var negativeAnswers = [ 'n', 'no' ];

    /*
     * Check if bundle isn't defined yet
     */
    fs.lstat( bundlesPath + "/" + nameBundle, function( err, stats ) {
        if ( !err && stats.isDirectory() ) {
            Message.error({
                title: "Impossible to create bundle",
                message: nameBundle + " bundle already exists.",
                consequence: "Creation aborted.",
                exit: 0
            });
        } else {
            checkIfSkeletonIsDefined();
        }
    });

    function checkIfSkeletonIsDefined() {
        /*
         * Check if Skeleton bundle is defined
         */
        fs.lstat( skeletonBundlePath, function ( err, stats ) {
            if ( err || !stats.isDirectory() ) {
                Message.error({
                    title: "Impossible to create bundle",
                    message: "Skeleton bundle isn't defined.",
                    consequence: "Creation aborted.",
                    exit: 0
                });
            } else {
                askForTable();
            }
        });
    }

    function askForTable() {
        var createAssociatedTable = readlineSync.question( 'Do you want create an associated table into database? (y/n) ' ).trim().toLowerCase();

        if ( _.indexOf( positiveAnswers, createAssociatedTable ) !== -1 ) {
            /*
             * Table associated requested
             */
            checkExistanceOfSchemaFile( function() {
                askForTableName();
            });
        } else if ( _.indexOf( negativeAnswers, createAssociatedTable ) !== -1 ) {
            /*
             * No table associated requested
             */
            createBundleDirectory();
        } else {
            askForTable();
        }
    }

    var tableName = '';
    function askForTableName() {
        console.log( '\n' );

        var defaultTableName    = stringTransform.asSnakeCase( nameBundleLowerCase ) + 's';
        var answerTableName     = stringTransform.asSnakeCase( readlineSync.question( 'Table name (default: ' + defaultTableName + '): ' ) );

        tableName = ( answerTableName.length > 0 ) ? answerTableName : defaultTableName;

        askForProperties();
    }

    var properties              = {};
    var availablesColumnType    = [ 'increments', 'integer', 'bigInteger', 'text', 'string', 'float', 'decimal', 'boolean', 'date', 'datetime', 'time', 'timestamp' ];
    var specialColumnType       = [ 'increments', 'integer', 'bigInteger', 'text', 'string', 'float', 'decimal' ];

    function askForProperties() {
        console.log( '\n' );
        /*
         * We ask for properties
         */
        var columnName          = stringTransform.asSnakeCase( readlineSync.question( 'Column name (let empty if the table is complete): ' ) );
        var propertiesLength    = Object.keys( properties ).length;

        if ( columnName.length === 0 && propertiesLength === 0 ) {
            askForTable();
        } else if ( columnName.length === 0 && propertiesLength > 0 ) {
            createTable();
        } else {
            var columnType = stringTransform.cleanAccents( readlineSync.question( 'Column type: (availables: ' + availablesColumnType.join( ', ' ) + '): ' ).toLowerCase().trim() );

            if ( _.indexOf( availablesColumnType, columnType ) !== -1 ) {
                /*
                 * Everything is ok, we push new column
                 */
                properties[ columnName ] = {};
                properties[ columnName ].type = columnType;

                /*
                 * Special property ? Ask for more details
                 */
                if ( _.indexOf( specialColumnType, columnType ) !== -1 ) {
                    askDetailsForSpecialColumnType( columnType, columnName );
                }

                askForProperties();
            } else {
                Message.error({
                    title: "Column type not valid",
                    message: "Column type can be: " + availablesColumnType.join( ', ' )
                });
                askForProperties();
            }
        }
    }

    function askDetailsForSpecialColumnType( type, columnName ) {
        var property = properties[ columnName ];

        switch ( type ) {

            case 'increments':
                var anwserDefineAsPrimary = readlineSync.question( 'Define as primary? (y/n) ' ).trim().toLowerCase();

                if ( _.indexOf( positiveAnswers, anwserDefineAsPrimary ) !== -1 ) {
                    /*
                     * Define as primary
                     */
                    property.primary = true;
                } else if ( _.indexOf( negativeAnswers, anwserDefineAsPrimary ) === -1 ) {
                    /*
                     * Not recognized answer
                     */
                    askDetailsForSpecialColumnType( type, columnName );
                }

                askForUniqueColumn( columnName );
                property.nullable = false;
                break;

            case 'integer':
            case 'bigInteger':
                var answerIsAReference = readlineSync.question( 'Define as reference (foreign key)? (y/n) ' ).trim().toLowerCase();

                if ( _.indexOf( positiveAnswers, answerIsAReference ) !== -1 ) {
                    /*
                     * Define as reference
                     */
                    property.unsigned = true;

                    var answerReference = readlineSync.question( 'Table.ColumnId as reference (exemple: roles.id): ' ).trim().toLowerCase();

                    if ( answerReference.indexOf( '.' ) !== -1 && answerReference.match( /^\w+\.\w+$/ ) ) {
                        property.references = answerReference;

                        var validsOnEventAction     = [ 'restrict', 'cascade', 'set null', 'no action' ];
                        var defaultOnEventAction    = 'restrict';

                        /*
                         * OnDelete
                         */
                        var answerOnDelete = readlineSync.question( 'On delete action: (' + validsOnEventAction.join( ', ' ) + ', default: ' + defaultOnEventAction + ') ').trim().toLowerCase();

                        if ( _.indexOf( validsOnEventAction, answerOnDelete ) !== -1 ) {
                            property.onDelete = answerOnDelete;
                        } else {
                            property.onDelete = defaultOnEventAction;
                        }

                        /*
                         * OnUpdate
                         */
                        var answerOnUpdate = readlineSync.question( 'On update action: (' + validsOnEventAction.join( ', ' ) + ', default: ' + defaultOnEventAction + ') ').trim().toLowerCase();

                        if ( _.indexOf( validsOnEventAction, answerOnUpdate ) !== -1 ) {
                            property.onUpdate = answerOnUpdate;
                        } else {
                            property.onUpdate = defaultOnEventAction;
                        }
                    } else {
                        /*
                         * Wrong reference
                         */
                        delete property.unsigned;
                        Message.error({
                            title: "Wrong reference",
                            message: "Reference -> " + answerReference + " is not a valid reference."
                        });
                        askDetailsForSpecialColumnType( type, columnName );
                    }
                }

                askForUniqueColumn( columnName );
                askForNullableColumn( columnName );
                break;

            case 'text':
                var validsTextType  = [ 'text', 'mediumtext', 'longtext' ];
                var defaultTextType = 'text';
                var anwserTypeOfText = readlineSync.question( 'Which kind of text? ( ' + validsTextType.join( ', ' ) + ', default: ' + defaultTextType + ') ' ).trim().toLowerCase();

                if ( _.indexOf( validsTextType, anwserTypeOfText ) !== -1 ) {
                    property.fieldtype = anwserTypeOfText;
                } else {
                    property.fieldtype = defaultTextType;
                }

                askForNullableColumn( columnName );
                break;

            case 'string':
                var minLength = 1, maxLength = 255;
                var answerMaxLength = readlineSync.question( 'Max length (' + minLength + '-' + maxLength + ', default: ' + maxLength + '): ' ).trim();

                if ( !isNaN( answerMaxLength ) && answerMaxLength >= minLength && answerMaxLength <= maxLength ) {
                    /*
                     * Ok
                     */
                    property.maxlength = parseInt( answerMaxLength );
                } else if ( !isNaN( answerMaxLength ) ) {
                    /*
                     * Not in range, default value applicated
                     */
                    property.maxlength = maxLength;
                } else {
                    /*
                     * Wrong answer, we ask again
                     */
                    askDetailsForSpecialColumnType( type, columnName );
                }

                askForUniqueColumn( columnName );
                askForNullableColumn( columnName );
                break;

            case 'float':
            case 'decimal':
                var defaultPrecision = 8;

                var answerPrecision = readlineSync.question( 'Precision (integer, default: ' + defaultPrecision + '): ' ).trim();

                if ( answerPrecision.length === 0 || isNaN( answerPrecision ) || !isFinite( answerPrecision ) ) {
                    property.precision = defaultPrecision ;
                } else {
                    property.precision = parseInt( answerPrecision );
                }

                if ( 'decimal' === type ) {
                    /*
                     * Ask for scale
                     */
                    var defaultScale = 2;
                    var answerScale = readlineSync.question( 'Scale (integer, default: ' + defaultScale + ')' ).trim();

                    if ( answerScale.length === 0 || isNaN( answerScale ) || !isFinite( answerScale ) ) {
                        property.scale = defaultScale ;
                    } else {
                        property.scale = parseInt( answerScale );
                    }
                }

                askForNullableColumn( columnName );
                break;
        }
    }

    function askForNullableColumn( columnName ) {
        var answerNullable = readlineSync.question( 'Define as nullable? (y/n) ' ).trim().toLowerCase();
        if ( _.indexOf( positiveAnswers, answerNullable ) !== -1 ) {
            /*
             * Define as nullable
             */
            properties[ columnName ].nullable = true;
        } else if ( _.indexOf( negativeAnswers, answerNullable ) !== -1 ) {
            /*
             * Not nullable
             */
            properties[ columnName ].nullable = false;
        } else {
            /*
             * Wrong answer
             */
            askForNullableColumn( columnName );
        }
    }

    function askForUniqueColumn( columnName ) {
        var answerAsUnique = readlineSync.question( 'Define as unique? (y/n) ' ).trim().toLowerCase();
        if ( _.indexOf( positiveAnswers, answerAsUnique ) !== -1 ) {
            /*
             * Define as unique
             */
            properties[ columnName ].unique = true;
        } else if ( _.indexOf( negativeAnswers, answerAsUnique ) !== -1 ) {
            /*
             * Not unique
             */
            properties[ columnName ].unique = false;
        } else {
            /*
             * Wrong answer
             */
            askForUniqueColumn( columnName );
        }
    }

    function createTable() {
        schemaBuilder.createTable( tableName, properties )
        .then( function() {
            updateSchema();
        })
        .catch( function( error ) {
            Message.error({
                title: "Error when creating table",
                message: error,
                consequence: "Bundle creation aborted.",
                exit: 0
            });
        });
    }

    function updateSchema() {
        /*
         * We stringify properties and insert it into ~/config/database/schema.js
         */
        checkExistanceOfSchemaFile( function() {
            var pathSchema = global.app.root + '/config/database/schema.js';
            fs.readFile( pathSchema, { encoding: 'utf8' }, function( error, data ) {
                if ( !error ) {
                    var stringToWrite = 'export default {\n\t' + tableName + ': ' + JSON.stringify( properties ) + ',\n\n';
                    var dataUpdated = data.replace( /export(\s*)default(\s)\{/i, stringToWrite );
                    fs.writeFile( pathSchema, dataUpdated, 'utf8', function ( error ) {
                        if ( !error ) {
                            createBundleDirectory();
                        } else {
                            errorEditingSchema( error );
                        }
                    });
                } else {
                    errorEditingSchema( error );
                }
            });
        });

        function errorEditingSchema( error ) {
            Message.error({
                title: "Impossible to update schema",
                message: "Error when editing schema.js file: " + error,
                consequence: "Bundle creation aborted.",
                exit: 0
            });
        }
    }

    function checkExistanceOfSchemaFile( cb ) {
        var pathSchema = global.app.root + '/config/database/schema.js';
        fs.lstat( pathSchema, function( error, stat ) {
            if ( !error & stat.isFile() ) {
                cb();
            } else {
                Message.error({
                    title: "Impossible to update schema",
                    message: "schema.js not found at: " + pathSchema,
                    consequence: "Bundle creation aborted.",
                    exit: 0
                });
            }
        });
    }

    function createBundleDirectory() {
        /*
         * Check if new bundle directory is correctly created
         */
        fs.mkdir( bundleCreatingPath, 0775, function( err ) {
            if ( err ) {
                Message.error({
                    title: "Impossible to create bundle",
                    message: "Error when trying create bundle directory.",
                    consequence: "Creation aborted.",
                    exit: 0
                });
            } else {
                launchWalker();
            }
        });
    }

    function launchWalker() {

        var walker = walk.walk( skeletonBundlePath );

        walker.on( "names", function ( root, nodeNamesArray ) {
            nodeNamesArray.sort( function ( a, b ) {
                if ( a > b ) return 1;
                if ( a < b ) return -1;
                return 0;
            });
        });

        walker.on( "directories", function ( root, dirStatsArray, next ) {
            // dirStatsArray is an array of `stat` objects with the additional attributes
            // * type
            // * error
            // * name
            var newDirName = '';
            for ( i in dirStatsArray ) {
              newDirName = dirStatsArray[ i ].name.replace( /Skeleton/gi, nameBundle );
              fs.mkdir( bundleCreatingPath + '/' + newDirName, function( err ) {
                  if ( err ) {
                      Message.error({
                          title: "Impossible to create bundle",
                          message: "Error when trying create bundle sub-directory <" + newDirName + ">.",
                          consequence: "Creation aborted.",
                          exit: 0
                      });
                  }
              });
            }

            next();
        });

        walker.on( "file", function ( root, fileStats, next ) {
            var skeletonFilePath = path.join( root, fileStats.name );
            var newBundleFilePath = skeletonFilePath.replace( /Skeleton/g, nameBundle);

            try {
                var data = fs.readFileSync( skeletonFilePath, 'utf8' );
                /*
                 * We write tableName specified above
                 */
                if ( fileStats.name.toLowerCase().indexOf( 'skeleton.js' ) !== -1 ) {
                    data = data.replace( /tableName(\s*):(\s*)('|")\w*('|")/i, 'tableName$1:$2$3' + tableName + '$4' );
                }

                fs.writeFileSync( newBundleFilePath, data.replace( /Skeleton/g, nameBundle ).replace( /skeleton/g, nameBundleLowerCase ), { encoding: 'utf8', mode: 0775 } );
                next();
            } catch( error ) {
                Message.error({
                    title: "Impossible to create bundle",
                    message: "Error: " + JSON.stringify( error ),
                    consequence: "Creation aborted.",
                    exit: 0
                });
            }
        });

        walker.on( "errors", function ( root, nodeStatsArray, next ) {
            next();
        });

        walker.on( "end", function () {
            Message.success( "\nBundle " + nameBundle + " created.", true );
        });

    }

} else {
    Message.info( "\nCommand: \n[node] createBundle nameOfBundle\n" );
    process.exit();
}
