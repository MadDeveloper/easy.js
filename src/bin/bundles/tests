#!/usr/bin/env node
import fs                                   from 'fs'
import Mocha                                from 'mocha'
import path                                 from 'path'
import minimist                             from 'minimist'
import { kernel, bundleManager, container } from './../../bootstrap.js'

const argv = minimist( process.argv.slice( 2 ) )

const cli                   = container.getComponent( 'Console' )
const bundlesTestsDirectory = kernel.path.test.bundles
/*
 * Instantiate a Mocha instance
 */
const mocha = new Mocha()

/*
 * Expose container into global scope for unit tests classes, because file are called by mocha and not ourselves
 */
global.container = container

/*
 * Add each .js file to the mocha instance
 */
fs.readdir( bundlesTestsDirectory, ( err, files ) => {
    if ( !err && files.length > 0 ) {
        files.forEach( bundle => {
            const testsDir = `${bundlesTestsDirectory}/${bundle}`

            try {
                if ( fs.lstatSync( testsDir ).isDirectory() ) {
                    const specFiles = fs.readdirSync( testsDir )

                    if ( specFiles && specFiles.length > 0 ) {
                        specFiles.forEach( specFile => {
                            mocha.addFile(
                                path.join( testsDir, specFile )
                            )
                        })
                    }
                }
            } catch( e ) {
                cli.warn( `No unit tests found for ${bundle} bundle.` )
                cli.line()
            }
        })

        /*
         * Run the tests
         */
        mocha.run( failures => {
            if ( failures ) {
                cli.warn( `${failures} failures occurs during tests.` )
                cli.line()
            }
            process.exit()
        })
    }
})
