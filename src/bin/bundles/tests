#!/usr/bin/env node
import fs               from 'fs'
import Mocha            from 'mocha'
import path             from 'path'
import minimist         from 'minimist'
import Console          from '~/vendor/easy/core/Console'
import { kernel,
         bundleManager,
         container }    from '~/bootstrap'

const argv                  = minimist( process.argv.slice( 2 ) )
const bundlesTestsDirectory = kernel.path.test.bundles
/*
 * Instantiate a Mocha instance
 */
const mocha = new Mocha()

/*
 * Add each .js file to the mocha instance
 */
fs.readdir( bundlesTestsDirectory, ( err, files ) => {
    if ( !err && files.length > 0 ) {
        files.forEach( bundle => {
            const testsDir = `${bundlesTestsDirectory}/${bundle}`

            try {
                if ( fs.lstatSync( testsDir ).isDirectory() ) {
                    const specFiles = fs.readdirSync( testsDir )

                    if ( specFiles && specFiles.length > 0 ) {
                        specFiles.forEach( specFile => {
                            mocha.addFile(
                                path.join( testsDir, specFile )
                            )
                        })
                    }
                }
            } catch( e ) {
                Console.warn( `No unit tests found for ${bundle} bundle.` )
                Console.line()
            }
        })

        /*
         * Run the tests
         */
        mocha.run( failures => {
            if ( failures ) {
                Console.warn( `${failures} failures occurs during tests.` )
                Console.line()
            }
            process.exit()
        })
    }
})
