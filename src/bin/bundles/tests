#!/usr/bin/env node
import fs                           from 'fs'
import Mocha                        from 'mocha'
import path                         from 'path'
import minimist                     from 'minimist'
import { kernel, bundleManager }    from './../../bootstrap.js'

let argv = minimist( process.argv.slice( 2 ) )

const container         = bundleManager.container
const message           = container.getComponent( 'Message' )
const bundlesDirectory  = kernel.path.bundles

/*
 * Instantiate a Mocha instance
 */
const mocha = new Mocha()

/*
 * Expose container into global scope for unit tests classes, because file are called by mocha and not ourselves
 */
global.container = container

/*
 * Add each .js file to the mocha instance
 */
fs.readdirSync( bundlesDirectory )
    .forEach( bundle => {
        const testsDir = bundlesDirectory + '/' + bundle + '/tests'

        try {
            if ( fs.lstatSync( testsDir ).isDirectory() ) {
                const specFiles = fs.readdirSync( testsDir )

                if ( specFiles && specFiles.length > 0 ) {
                    specFiles.forEach( specFile => {
                        mocha.addFile(
                            path.join( testsDir, specFile )
                        )
                    })
                }
            }
        } catch( e ) {
            message.warn( 'No unit tests found for ' + bundle + ' bundle.' )
        }
    })

/*
 * Run the tests
 */
mocha.run( failures => {
    if ( failures ) {
        message.warn( failures  + ' failures occurs during tests.' )
    }
    process.exit()
})
