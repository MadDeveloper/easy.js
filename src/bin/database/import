#!/usr/bin/env node
import execsql	from 'execsql'
import config  	from './../../config/config'
import App      from './../../bootstrap.js'

let argv    = minimist( process.argv.slice( 2 ) )
let cliMode = true

const dbConfig = {
	host: config.database.connection.host,
	user: config.database.connection.user,
	password: config.database.connection.password
}

const app 			= new App( config, cliMode )
const kernel        = app.kernel
const bundleManager	= app.bundleManager
const container     = bundleManager.container
const message       = container.getComponent( 'Message' )

const titleError		= "Error when importing database"
const consequenceError	= "Importation aborted."

const sql       = 'use ' + config.database.connection.database + ''
const sqlFile	= kernel.path.config + '/config/database/' + config.database.connection.database + '.sql'

function raiseError( err ) {
	message.error({
		title: titleError,
		message: err,
		consequence: consequenceError,
		exit: 0
	})
}

execsql.config( dbConfig )
.exec( sql, ( err, results ) => {
    if ( err ) {
        raiseError( err )
    }
})
.execFile( sqlFile, ( err, results ) => {
    if ( err ) {
        raiseError( err )
    } else {
		message.success( "Database imported.", true )
    }
    process.exit()
})
