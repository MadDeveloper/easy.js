#!/usr/bin/env node

var cliMode     = true;
var config      = require( __dirname + '/../config/config' );
var components  = require( __dirname + '/../bootstrap' )( config, cliMode );
var Message     = components.Kernel.load( 'Message' )();
var fs          = require( 'fs' );
var walk        = require( 'walk' );
var Mocha       = require( 'mocha' );
var path        = require( 'path' );

/*
 * Expose as global BundleManager
 */
global.BundleManager = components.BundleManager;

/*
 * Instantiate a Mocha instance
 */
var mocha = new Mocha();

var BundlesDirectory = __dirname + '/../src/Bundles';

/*
 * Add each .js file to the mocha instance
 */
fs.readdirSync( BundlesDirectory )
    .forEach( function( bundle ) {
        var testsDir = BundlesDirectory + '/' + bundle + '/Tests';
        try {
            if ( fs.lstatSync( testsDir ).isDirectory() ) {
                var files = fs.readdirSync( testsDir );
                if ( files && files.length > 0 ) {
                    files.forEach( function( file ) {
                        mocha.addFile(
                            path.join( testsDir, file )
                        );
                    });
                }
            }
        } catch( e ) {
            Message.warn( 'No unit tests found for ' + bundle + ' bundle.' );
        }
    });

/*
 * Run the tests
 */
mocha.run( function( failures ) {
    if ( failures ) {
        Message.warn( failures  + ' failures occurs during tests.' );
    }
    process.exit();
});
